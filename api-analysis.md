# API split separation

## API identifiers mapping

We are porting the following API endpoints to NPQ. The transition should be as transparent as possible from the Lead Providers perspective:

```
GET  /api/v3/npq-applications
GET  /api/v3/npq-applications/{application_id}
POST /api/v3/npq-applications/{application_id}/accept
POST /api/v3/npq-applications/{application_id}/reject
GET  /api/v3/participants/npq/outcomes
GET  /api/v3/participants/npq/{participant_id}/outcomes
POST /api/v3/participants/npq/{participant_id}/outcomes
GET  /api/v3/participants/npq
GET  /api/v3/participants/npq/{participant_id}
PUT  /api/v3/participants/npq/{participant_id}/change-schedule
PUT  /api/v3/participants/npq/{participant_id}/defer
PUT  /api/v3/participants/npq/{participant_id}/resume
PUT  /api/v3/participants/npq/{participant_id}/withdraw
```

## Identifiers: technical analysis

### API endpoints that receive an `application_id`

```
GET  /api/v3/npq-applications/{application_id}
POST /api/v3/npq-applications/{application_id}/accept
POST /api/v3/npq-applications/{application_id}/reject
```

The parameter `application_id`:

1. Is generated by ECF.
2. Is [stored in the `ecf_id`][application-ecf-id] column in NPQ
3. Is returned to Lead Providers via [an API endpoint response][accept-parameter].

#### Actions

1. No need to migrate ECF `application_id` as this information is already present in the attribute: `ecf_id` in the `applications` table in NPQ.
2. `application_id` will be returned to LP via [the response of this endpoint][accept-parameter]:
   - For existing applications (previous to the split), it will return `ecf_id` from the current `applications` table. The endpoint in NPQ will continue managing / using the same `UUID` 
   - For new applications (after the split), it will return a new `UUID` which will be also stored in the `applications` table (`ecf_id`) field.
3. Rename `ecf_id` to `lead_provider_application_id`, so we break the link between NPQ and ECF ([ECF is no longer the owner of the identifiers][application-ecf-id]).

**Notes:**

> The migrations of application identifiers will be transparent for Lead Providers.


### API endpoints that receive `participant_id`s

```
GET  /api/v3/participants/npq/{participant_id}/outcomes
POST /api/v3/participants/npq/{participant_id}/outcomes
PUT  /api/v3/participants/npq/{participant_id}/change-schedule
PUT  /api/v3/participants/npq/{participant_id}/defer
PUT  /api/v3/participants/npq/{participant_id}/resume
PUT  /api/v3/participants/npq/{participant_id}/withdraw

```

The parameter `participant_id`:

1. Is generated and managed in ECF
2. In ECF is used to support multiple emails/identities and have proven to be difficult to reason about. In NPQ we have decided to simplify them as NPQ requirements are simpler
3. In NPQ a `participant_id` is the `user_id`. 
4. In NPQ, there is only one accepted application per participant and course. 

#### Actions

1. No need to migrate `participant_id` as this information is already present in the attribute: `ecf_id` in the `users` table in NPQ.
2. The `participant_id` will be returned to LP via the endpoints
   - For existing participants, we will return the `ecf_id` from the current `users` table. The endpoint in NPQ will continue managing / using the same `UUID`
   - For new participants, we will return a new `UUID` which will be also stored in the `users` table (`ecf_id`) field.
3. Rename `ecf_id` to `lead_provider_participant_id`, so we break the link between NPQ and ECF.
4. Create a `Finder` in NPQ to locate an application using the course and the participant. 

[application-ecf-id]: https://github.com/DFE-Digital/npq-registration/blob/452b3831254eb32c3e72c6118ee2980a1df72b6f/db/schema.rb#L32
[accept-parameter]: https://manage-training-for-early-career-teachers.education.gov.uk/api-reference/reference-v3.html#api-v3-npq-applications-id-accept-post-parameters
